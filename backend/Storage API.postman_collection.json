{
  "info": {
    "_postman_id": "mezartasi-contacts-mail-cookie-only",
    "name": "BBB Mezartasi — Contacts + Mail [Cookie-only]",
    "description": "Contact formu + admin contact yönetimi + mail modülü (SMTP, order-created) uçtan uca testleri. Auth tamamen Cookie Jar (login ile Set-Cookie). Header'da Bearer/Cookie kullanılmaz.",
    "schema": "https://schema.getpostman.com/json/collection/v2.0.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global pre-request: timestamp sadece 1 kere set edilsin",
          "if (!pm.environment.get('timestamp')) {",
          "  pm.environment.set('timestamp', Date.now().toString());",
          "}",
          "// Order number gibi yerlerde kullanılabilir",
          "if (!pm.environment.get('order_number')) {",
          "  pm.environment.set('order_number', 'ORD-' + pm.environment.get('timestamp'));",
          "}"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Auth: Login (sets cookie)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{admin_email}}\",\n  \"password\": \"{{admin_password}}\"\n}"
            },
            "url": "{{base_url}}/api/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200/204/302', () => pm.expect([200,204,302]).to.include(pm.response.code));",
                  "// Postman Set-Cookie'yi Cookie Jar'a ekleyecek."
                ]
              }
            }
          ]
        },
        {
          "name": "Auth: Status (optional)",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url}}/api/auth/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Contacts (Public)",
      "item": [
        {
          "name": "01) Public: Create Contact (form submit)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Test Kullanıcı\",\n  \"email\": \"{{public_contact_email}}\",\n  \"phone\": \"+90 533 000 00 00\",\n  \"subject\": \"İletişim Formu Testi {{timestamp}}\",\n  \"message\": \"Bu bir iletişim formu test mesajıdır. Timestamp: {{timestamp}}\",\n  \"website\": \"\"\n}"
            },
            "url": "{{base_url}}/api/contacts"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('201 Created', () => pm.response.to.have.status(201));",
                  "const body = pm.response.json();",
                  "pm.test('ok:true', () => pm.expect(body.ok).to.eql(true));",
                  "pm.test('id mevcut', () => pm.expect(body.id).to.be.a('string').and.not.empty);",
                  "pm.environment.set('contact_id', body.id);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Contacts (Admin)",
      "item": [
        {
          "name": "02) Admin: List Contacts → set contact_id if empty",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url}}/api/admin/contacts"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const arr = pm.response.json();",
                  "pm.expect(arr).to.be.an('array');",
                  "pm.test('En az 1 kayıt', () => pm.expect(arr.length).to.be.above(0));",
                  "if (!pm.environment.get('contact_id') && arr.length) {",
                  "  pm.environment.set('contact_id', arr[0].id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "03) Admin: Get Contact by id",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url}}/api/admin/contacts/{{contact_id}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const c = pm.response.json();",
                  "pm.test('id === contact_id', () => pm.expect(c.id).to.eql(pm.environment.get('contact_id')));",
                  "pm.test('email alanı var', () => pm.expect(c).to.have.property('email'));",
                  "pm.test('status alanı var', () => pm.expect(c).to.have.property('status'));"
                ]
              }
            }
          ]
        },
        {
          "name": "04) Admin: Update Contact (status + note)",
          "request": {
            "method": "PATCH",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"status\": \"in_progress\",\n  \"is_resolved\": false,\n  \"admin_note\": \"Postman testi ile güncellendi ({{timestamp}}).\"\n}"
            },
            "url": "{{base_url}}/api/admin/contacts/{{contact_id}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const c = pm.response.json();",
                  "pm.test('status in_progress', () => pm.expect(c.status).to.eql('in_progress'));",
                  "pm.test('is_resolved false', () => pm.expect(c.is_resolved).to.eql(false));",
                  "pm.test('admin_note dolu', () => pm.expect(c.admin_note).to.be.a('string'));"
                ]
              }
            }
          ]
        },
        {
          "name": "05) Admin: Close & Resolve Contact",
          "request": {
            "method": "PATCH",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"status\": \"closed\",\n  \"is_resolved\": true,\n  \"admin_note\": \"Talep çözüldü ve kapatıldı ({{timestamp}}).\"\n}"
            },
            "url": "{{base_url}}/api/admin/contacts/{{contact_id}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const c = pm.response.json();",
                  "pm.test('status closed', () => pm.expect(c.status).to.eql('closed'));",
                  "pm.test('is_resolved true', () => pm.expect(c.is_resolved).to.eql(true));"
                ]
              }
            }
          ]
        },
        {
          "name": "06) Admin: Delete Contact",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": "{{base_url}}/api/admin/contacts/{{contact_id}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const body = pm.response.json();",
                  "pm.test('ok alanı true/false', () => pm.expect(body).to.have.property('ok'));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Mail",
      "item": [
        {
          "name": "01) Mail: Test SMTP (explicit to)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"to\": \"{{mail_test_to}}\"\n}"
            },
            "url": "{{base_url}}/api/mail/test"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const body = pm.response.json();",
                  "pm.test('ok:true', () => pm.expect(body.ok).to.eql(true));"
                ]
              }
            }
          ]
        },
        {
          "name": "02) Mail: Test SMTP (current user email)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            },
            "url": "{{base_url}}/api/mail/test"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK veya 400', () => pm.expect([200,400]).to.include(pm.response.code));",
                  "if (pm.response.code === 200) {",
                  "  const body = pm.response.json();",
                  "  pm.test('ok:true', () => pm.expect(body.ok).to.eql(true));",
                  "} else {",
                  "  const err = pm.response.json();",
                  "  pm.test('to_required hatası', () => pm.expect(err.error && err.error.message).to.eql('to_required_for_test_mail'));",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "03) Mail: Send generic mail (/mail/send)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"to\": \"{{mail_to}}\",\n  \"subject\": \"Genel Mail Testi {{timestamp}}\",\n  \"text\": \"Bu bir genel mail testidir (plain text).\",\n  \"html\": \"<p>Bu bir <strong>genel mail testidir</strong>. Timestamp: {{timestamp}}</p>\"\n}"
            },
            "url": "{{base_url}}/api/mail/send"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('201 Created', () => pm.response.to.have.status(201));",
                  "const body = pm.response.json();",
                  "pm.test('ok:true', () => pm.expect(body.ok).to.eql(true));"
                ]
              }
            }
          ]
        },
        {
          "name": "04) Mail: Order Created (/mail/order-created)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"to\": \"{{order_mail_to}}\",\n  \"customer_name\": \"Test Müşteri\",\n  \"order_number\": \"{{order_number}}\",\n  \"final_amount\": \"199.90\",\n  \"status\": \"pending\",\n  \"site_name\": \"Mezarisim.com\",\n  \"locale\": \"tr-TR\"\n}"
            },
            "url": "{{base_url}}/api/mail/order-created"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('201 Created', () => pm.response.to.have.status(201));",
                  "const body = pm.response.json();",
                  "pm.test('ok:true', () => pm.expect(body.ok).to.eql(true));"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    { "key": "base_url", "value": "http://localhost:8083" },
    { "key": "admin_email", "value": "orhanguzell@gmail.com" },
    { "key": "admin_password", "value": "admin123" },

    { "key": "public_contact_email", "value": "test-contact@example.com" },

    { "key": "mail_test_to", "value": "test-smtp@example.com" },
    { "key": "mail_to", "value": "test-generic@example.com" },
    { "key": "order_mail_to", "value": "test-order@example.com" },

    { "key": "timestamp", "value": "" },
    { "key": "order_number", "value": "" },
    { "key": "contact_id", "value": "" }
  ]
}
